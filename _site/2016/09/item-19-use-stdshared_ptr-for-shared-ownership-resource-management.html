<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Cowboybebop's Notes</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xiongm.github.io/js/jquery.min.js"></script>
  <script src="https://xiongm.github.io/js/bootstrap.min.js"></script>
  <script src="https://xiongm.github.io/js/header.js"></script>
  <script src="https://xiongm.github.io/js/toc.js"></script>
  <link href="https://xiongm.github.io/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xiongm.github.io/css/theme.css" rel="stylesheet">
  <link href="https://xiongm.github.io/css/syntax.css" rel="stylesheet">
  <link href="https://xiongm.github.io/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xiongm.github.io/">Cowboybebop's Notes</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xiongm.github.io/">/home</a></li>
          <li><a href="https://xiongm.github.io/archive.html">/archive</a></li>
          <li><a href="https://xiongm.github.io/tags.html">/tags</a></li>
          <li><a href="https://xiongm.github.io/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xiongm.github.io/2016/09/item-19-use-stdshared_ptr-for-shared-ownership-resource-management">Item 19: Use std::shared_ptr for shared-ownership resource management.</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>12 Sep 2016</time>
                </div>
                <ul>
                  
                    <li><a href="https://xiongm.github.io/tag/modernc++">modernc++</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <p>shared_ptr is C++â€™s way of garbage collector. All shared_ptr holders collectively own the underlying object and when the last holder exits, the object will be destroyed, automatically.</p>

<p>shared_ptr increment ref count in constructor, copy constructor, and copy assignment operator (copy assignment operator also decrement ref count of the object originally pointed to, so copy assignment operator does both). Note that move constructor DOES NOT increment ref counts.</p>

<p>shared_ptr has performance implications because it needs to keep book information of the ref count, thus having twice the size of raw pointer. And to be thread safe, it needs to increment and decrement its ref count in atomic operation, which is usually slower than non atomic operation.</p>

<p>shared_ptr typically has two pointers, one pointing to the object, and another pointing to a control block dynamically allocated shared by all shared_ptrs. The control block should be set up  when first shared_ptr to an object is created. Per C++ 11, control block will be created when</p>

<ul>
  <li>make_shared is called</li>
  <li>unique_ptr is converted to shared_ptr</li>
  <li>when shared_ptr constructor is called with pointer</li>
</ul>

<p>The last approach is probably the most common way of creating a shared_ptr. In reality thou, it is possible that creating two shared_ptrs from the same raw pointer can result in two control blocks being created, thus causing duplicate ref counting, which is bad! See below</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyObject</span><span class="p">();</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="c1">//
</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span> <span class="n">b</span><span class="p">(</span><span class="n">p</span><span class="p">);</span></code></pre></figure>

<p>The lesson here is to either use make_shared, or use new directly inside shared_ptr constructor.<br />
Another way to introduce this kind of duplicate-control-block issue has to do with using this pointer. Sometimes, we have to create shared_ptr out of this pointer after the object has been created, so we can not use the methods mentioned above to avoid passing raw pointer directly to shared_ptr.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">vector</span><span class="o">&lt;</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;&gt;</span> <span class="n">objects</span><span class="p">;</span>
<span class="c1">// bad! what if there are other shared_ptrs already
// pointing to the object? meaning that at least one control block
// has been created, but passing raw pointer to shared_ptr constructor will surely
// create a control block, resulting in duplicate control blocks
</span><span class="n">objects</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></code></pre></figure>

<p>This is exactly why we need to use enable_shared_from_this(), in case you have been using this for a while but never ask yourself why</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">MyObjects</span> <span class="o">:</span> <span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">MyObjects</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">};</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;&gt;</span> <span class="n">objects</span>
<span class="p">...</span>
<span class="n">objects</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span></code></pre></figure>


                

              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2016/09/item-22-when-using-the-pimpl-idiom-define-special-member-functions-in-the-implementation-file">Item 22: When using the Pimpl Idiom, define special member functions in the implementation file</a></li>
    
    <li><a href="/2016/09/item-21-prefer-stdmake_unique-and-stdmake_shared-to-direct-use-of-new">Item 21 Prefer std::make_unique and std::make_shared to direct use of new.</a></li>
    
    <li><a href="/2016/09/item-20-use-stdweak_ptr-for-stdshared_ptr-like-pointers-that-can-dangle">Item 20: Use std::weak_ptr for std::shared_ptr like pointers that can dangle</a></li>
    
    <li><a href="/2016/09/item-19-use-stdshared_ptr-for-shared-ownership-resource-management">Item 19: Use std::shared_ptr for shared-ownership resource management.</a></li>
    
    <li><a href="/2016/09/item-18-use-stdunique_ptr-for-exclusive-ownership-resource-management">Item 18: Use std::unique_ptr for exclusive-ownership resource management</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="/tag/jekyll">jekyll</a></li>
    
      <li><a href="/tag/analytics">analytics</a></li>
    
      <li><a href="/tag/tags">tags</a></li>
    
      <li><a href="/tag/comments">comments</a></li>
    
      <li><a href="/tag/code">code</a></li>
    
      <li><a href="/tag/images">images</a></li>
    
      <li><a href="/tag/LeetCode">LeetCode</a></li>
    
      <li><a href="/tag/C++">C++</a></li>
    
      <li><a href="/tag/modernc++">modernc++</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    

  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Cowboybebop98 &copy; 2016</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="xiongm on Github" href="https://github.com/xiongm" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title=" on StackOverflow" href="http://stackoverflow.com/users/" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  

  
    <li>
      <a title=" on Instagram" href="https://instagram.com/" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title=" on Last.fm" href="http://lastfm.com/user/" target="_blank"><i class="fa fa-lastfm fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="feed.xml RSS" href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
